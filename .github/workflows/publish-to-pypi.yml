# Publish archives to PyPI and TestPyPI using GitHub Actions
# https://packaging.python.org/en/latest/guides/publishing-package-distribution-releases-using-github-actions-ci-cd-workflows/

name: Publish to PyPI

# Only run for pushes to the main branch and releases.
on:
  push:
    branches:
      - main
  release:
    types:
      - published
  # Runs for pull requests should be disabled other than for testing purposes
  #pull_request:
  #  branches:
  #    - main

permissions:
  contents: read

jobs:
  publish-pypi:
    name: Build and publish Python üêç distributions üì¶ to PyPI and TestPyPI
    runs-on: ubuntu-22.04
    permissions:
      # This permission is mandatory for OIDC publishing
      id-token: write
    if: github.repository == 'weiji14/zen3geo'

    steps:
      - name: Checkout
        uses: actions/checkout@2541b1294d2704b0964813337f33b291d3f8596b
        with:
          # fetch all history so that poetry-dynamic-versioning works
          fetch-depth: 0

      - name: Set up Python 3.11
        uses: actions/setup-python@d27e3f3d7c64b4bbf8e4abfb9b63b83e846e0435
        with:
          python-version: '3.11'

      - name: Install Poetry and dynamic-versioning plugin
        run: |
          pip install poetry==1.4.2
          poetry self add poetry-dynamic-versioning[plugin]
          poetry show

      - name: Fix up version string for TestPyPI and PyPI
        run: |
          # Change poetry-dynamic-versioning to use metadata=false so that the
          # local part of the version isn't included, making the version string
          # compatible with PyPI.
          sed --in-place "s/metadata = true/metadata = false/g" pyproject.toml

      - name: Build a binary wheel and a source tarball
        run: |
          poetry build -vvv
          echo ""
          echo "Generated files:"
          ls -lh dist/

      - name: Publish distribution üì¶ to Test PyPI
        uses: pypa/gh-action-pypi-publish@a3a3bafbb3e5a75a854ae1bc53ae128cf22c4af4
        with:
          repository_url: https://test.pypi.org/legacy/
          skip_existing: true

      - name: Publish distribution üì¶ to PyPI
        if: startsWith(github.ref, 'refs/tags')
        uses: pypa/gh-action-pypi-publish@a3a3bafbb3e5a75a854ae1bc53ae128cf22c4af4
